var fm;!function(t){"use strict";var e={chatListClass:"",chatElementClass:"",bubbleListClass:"",bubbleElementClass:"",inputContainerClass:"",inputBoxClass:"",inputButtonClass:"",previousResponsePattern:"{{previousResponse}}",formCompleteCallback:null,formValidation:{email:function(t){/^\w+([\.-]?\ w+)*@\w+([\.-]?\ w+)*(\.\w{2,3})+$/.test(t)||this.setErrorAndReply("Please provide a valid email.")},password:function(t){/(?=.*\d)(?=.*[a-z]).{6,}/.test(t)||this.setErrorAndReply("Password must contain one number, one lowercase and at least 6 in length.")},interest:function(t){t instanceof Array&&t.length<1&&this.setErrorAndReply("Please select at least one.")}}},i={userInputSubmit:"fm-user-input-submit",userInputUpdate:"fm-user-input-update",userInputKeyChange:"fm-user-input-key-change",onBubbleClick:"fm-on-bubble-click",onUserInputError:"fm-user-input-error",flowUpdate:"fm-flow-update"},n=function(t){};n.isTagValid=function(t){return!t.hasAttribute("fm-disabled")&&(!(["hidden","submit","button"].indexOf(t.getAttribute("type"))>=0)&&(!(["true","disabled"].indexOf(t.getAttribute("disabled"))>=0)&&"button"!=t.tagName))},n.isTagGroup=function(t){return["radio","checkbox"].indexOf(t.getAttribute("type"))>=0};var s=function(t){n.call(this),this.element=t};s.prototype=Object.create(n.prototype),s.prototype.constructor=s,s.prototype.getAttrName=function(){return this.element.getAttribute("name")},s.prototype.setInputValue=function(t){this.element.value=t},s.prototype.isInputSensitive=function(){return"password"==this.element.getAttribute("type")},s.prototype.getPlaceHolder=function(){return this.element.getAttribute("placeholder")},s.prototype.getBubbles=function(){var t=[];return this.element.value&&t.push({value:this.element.value,label:this.element.value}),t},s.prototype.getQuestion=function(){return(!this.questions||this.questions.length<=0)&&(this.questions=[],this.element&&this.element.getAttribute("fm-questions")&&(this.questions=this.element.getAttribute("fm-questions").split("|")),this.questions.length<=0&&this.questions.push("Please provide us your "+this.element.getAttribute("name"))),this.questions[Math.floor(Math.random()*this.questions.length)].trim()};var r=function(t,e){n.call(this),this.attrName=t,this.type=e,this.elements=[]};r.prototype=Object.create(n.prototype),r.prototype.constructor=r,r.prototype.getAttrName=function(){return this.attrName},r.prototype.addElement=function(t){this.elements.push(t)},r.prototype.setInputValue=function(t,e){this.elements.forEach(function(i){i.getAttribute("value")==t&&(i.checked=e)})},r.prototype.getQuestion=function(){var t=this;return(!this.questions||this.questions.length<=0)&&(this.questions=[],this.elements.some(function(e){var i=e.getAttribute("fm-questions");if(i)return t.questions=i.split("|"),!0}),this.questions.length<=0&&this.questions.push("Please provide us your "+this.attrName)),this.questions[Math.floor(Math.random()*this.questions.length)].trim()},r.prototype.getBubbles=function(){var t=[];return this.elements.forEach(function(e){t.push({value:e.value,label:e.getAttribute("fm-label")||e.value,isChecked:e.checked})}),t},r.prototype.getCheckedValuesForMsg=function(){var t=[];return this.elements.forEach(function(e){if(e.checked){var i=e.getAttribute("fm-label")||e.value;t.push(i)}}),t};var o=function(t){return this.step=0,this.maxSteps=t.tags.length,this.tags=t.tags,this.fmReference=t.fmReference,this.repeatStep=!1,this.userInputSubmitCallback=this.userInputSubmit.bind(this),document.addEventListener(i.userInputSubmit,this.userInputSubmitCallback,!1),this.onBubbleClickCallback=this.onBubbleClick.bind(this),document.addEventListener(i.onBubbleClick,this.onBubbleClickCallback,!1),this};Object.defineProperty(o.prototype,"currentTag",{get:function(){return this.tags[this.step]},enumerable:!0,configurable:!0}),o.prototype.start=function(){this.processStep()},o.prototype.nextStep=function(){this.step++,this.processStep()},o.prototype.processStep=function(){this.step==this.maxSteps?this.fmReference.doSubmitForm():(this.step%=this.maxSteps,this.showStep())},o.prototype.showStep=function(){var t=this;document.dispatchEvent(new CustomEvent(i.flowUpdate,{detail:t.currentTag}))},o.prototype.userInputSubmit=function(t){var e,n,o=this;if(this.repeatStep=!1,this.fmReference.isProcessing())return!1;if(this.fmReference.processing=!0,this.currentTag instanceof s){if(e=t.detail.value,n=e.trim(),this.currentTag.setInputValue(n),this.currentTag.isInputSensitive()){for(var l="",u=0;u<n.length;u++)l+="*";n=l}}else this.currentTag instanceof r&&(e=this.currentTag.getCheckedValuesForMsg(),n=e.join(", "));document.dispatchEvent(new CustomEvent(i.userInputUpdate,{detail:n})),this.validateInput(e)&&!this.repeatStep&&setTimeout(function(){return o.nextStep()},250)},o.prototype.onBubbleClick=function(t){var e=t.detail.value,i=t.detail.isChecked;this.currentTag instanceof s?this.userInputSubmit(t):this.currentTag instanceof r&&(this.currentTag.setInputValue(e,i),"radio"==this.currentTag.type&&this.userInputSubmit(t))},o.prototype.validateInput=function(t){var e=this.currentTag.getAttrName();return this.fmReference.options.formValidation.hasOwnProperty(e)&&this.fmReference.options.formValidation[e].call(this,t),!0},o.prototype.setErrorAndReply=function(t){this.repeatStep=!0,document.dispatchEvent(new CustomEvent(i.onUserInputError,{detail:t}))};var l=function(t){return this.fmReference=t,this.el=document.createElement("div"),this.el.id="fmChatList",this.el.className=this.fmReference.options.chatListClass.trim(),this.onUserInputUpdateCallback=this.onUserInputUpdate.bind(this),document.addEventListener(i.userInputUpdate,this.onUserInputUpdateCallback,!1),this};l.prototype.onUserInputUpdate=function(t){this.buildUserChatElement(t.detail),this.fmReference.setCurrentResponse(t.detail)},l.prototype.buildUserChatElement=function(t){var e=t||"Skip",i=document.createElement("div");i.className=("fm-chat-element fm-user fm-clearfix "+this.fmReference.options.chatElementClass).trim(),i.textContent=e,t||(i.className+=" skip"),this.el.appendChild(i),this.scrollToBottom()},l.prototype.buildBotChatElement=function(t,e){if(t){var i=document.createElement("div");i.className=("fm-chat-element fm-bot fm-clearfix "+this.fmReference.options.chatElementClass).trim(),i.textContent=t,e&&(i.className+=" error"),this.el.appendChild(i),this.scrollToBottom()}},l.prototype.scrollToBottom=function(){this.el.scrollTop=this.el.scrollHeight-this.el.clientHeight};var u=function(t){return this.fmReference=t,this.bubbles=[],this.filterableBubbles=!0,this.el=document.createElement("div"),this.el.id="fmBubbleList",this.el.className=this.fmReference.options.bubbleListClass.trim(),this.userInputKeyChangeCallback=this.userInputKeyChange.bind(this),document.addEventListener(i.userInputKeyChange,this.userInputKeyChangeCallback,!1),this};u.prototype.userInputKeyChange=function(t){if(this.bubbles.length>0&&this.filterableBubbles){var e=[];t.detail?this.bubbles.forEach(function(i){t.detail&&i.label.toLowerCase().indexOf(t.detail.toLowerCase())!==-1&&e.push(i)}):e=this.bubbles,this.renderBubbles(e)}},u.prototype.prePopulateBubble=function(t){this.bubbles=t.getBubbles(),this.filterableBubbles=!(t instanceof s),this.renderBubbles()},u.prototype.clearBubbles=function(){this.bubbles=[],this.renderBubbles()},u.prototype.renderBubbles=function(t){for(var e=this,t=t||this.bubbles;this.el.hasChildNodes();)this.el.removeChild(this.el.lastChild);t.length>0&&t.forEach(function(t){var i=document.createElement("div");i.className=("fm-bubble-element "+e.fmReference.options.bubbleElementClass).trim(),i.textContent=t.label,t.isChecked&&(i.className+=" selected"),e.el.appendChild(i),t.isFormSelection?i.addEventListener("click",function(){e.handleFormSelectionClick.call(e,t)},!1):i.addEventListener("click",function(){e.handleBubbleClick.call(this,t.value)},!1)})},u.prototype.handleBubbleClick=function(t){this.classList.toggle("selected"),document.dispatchEvent(new CustomEvent(i.onBubbleClick,{detail:{value:t,isChecked:this.classList.contains("selected")}}))},u.prototype.handleFormSelectionClick=function(t){var e=this;document.dispatchEvent(new CustomEvent(i.userInputUpdate,{detail:t.label})),setTimeout(function(){e.fmReference.initForm(t.value)},250)};var a=function(t){return this.fmReference=t,this.disabled=!1,this.referCurrentResponse=!0,this.el=document.createElement("div"),this.el.id="fmInputContainer",this.el.className=this.fmReference.options.inputContainerClass.trim(),this.inputEl=document.createElement("input"),this.inputEl.type="text",this.inputEl.id="fmInputBox",this.inputEl.className=this.fmReference.options.inputBoxClass.trim(),this.inputBtnEl=document.createElement("button"),this.inputBtnEl.type="button",this.inputBtnEl.id="fmInputBtn",this.inputBtnEl.innerHTML="Send",this.inputBtnEl.className=this.fmReference.options.inputButtonClass.trim(),this.el.appendChild(this.inputEl),this.el.appendChild(this.inputBtnEl),this.onKeyUpCallback=this.onKeyUp.bind(this),this.inputEl.addEventListener("keyup",this.onKeyUpCallback,!1),this.onEnterOrSubmitBtnCallback=this.onEnterOrSubmitBtn.bind(this),this.inputBtnEl.addEventListener("click",this.onEnterOrSubmitBtnCallback,!1),this};a.prototype.onKeyUp=function(t){var e=this;return!this.disabled&&void(13==t.keyCode?this.onEnterOrSubmitBtn():38==t.keyCode&&this.referCurrentResponse?this.inputEl.value=this.fmReference.currentResponse:document.dispatchEvent(new CustomEvent(i.userInputKeyChange,{detail:e.inputEl.value})))},a.prototype.onEnterOrSubmitBtn=function(){return!this.disabled&&void document.dispatchEvent(new CustomEvent(i.userInputSubmit,{detail:{value:this.inputEl.value}}))},a.prototype.hideUserInput=function(t){t?(this.referCurrentResponse=!1,this.inputEl.setAttribute("type","password")):this.inputEl.setAttribute("type","text")},a.prototype.setPlaceHolder=function(t){this.inputEl.setAttribute("placeholder",t)},a.prototype.focusInputBox=function(){this.inputEl.focus()},a.prototype.clearInput=function(){this.inputEl.value=""},a.prototype.setDisabled=function(t){this.disabled=!!t,t?(this.inputEl.setAttribute("disabled","disabled"),this.inputBtnEl.setAttribute("disabled","disabled")):(this.inputEl.removeAttribute("disabled"),this.inputBtnEl.removeAttribute("disabled"))},a.prototype.reset=function(){this.referCurrentResponse=!0,this.inputBtnEl.innerHTML="Send"},a.prototype.setInputBtnLabel=function(t){this.inputBtnEl.innerHTML=t};var h=function(t){if(!t.formEl&&!t.formSelection)throw new Error("Conversational Form error, Invalid formEl.");var n=this;this.options=Object.assign({},e,t),this.formEl=t.formEl,this.containerEl=t.containerEl?t.containerEl:document.body,this.tags=[],this.currentResponse="",this.processing=!1,this.buildUI(),this.onFlowUpdateCallback=this.onFlowUpdate.bind(this),document.addEventListener(i.flowUpdate,this.onFlowUpdateCallback,!1),this.onUserInputErrorCallback=this.onUserInputError.bind(this),document.addEventListener(i.onUserInputError,this.onUserInputErrorCallback,!1),this.formEl?(this.formEl.setAttribute("novalidate",""),setTimeout(function(){return n.initForm(n.formEl)},0)):t.formSelection&&this.setFormSelection(t.formSelection,t.formSelectionQuestion)};h.prototype.isProcessing=function(){return this.processing===!0},h.prototype.initForm=function(t){this.formEl=t;for(var e=[].slice.call(this.formEl.querySelectorAll("input, button"),0),i={},l=0;l<e.length;l++){var u=e[l];if(n.isTagValid(u))if(n.isTagGroup(u)){var a=u.getAttribute("name"),h=u.getAttribute("type");if(!i.hasOwnProperty(a)){var p=new r(a,h);this.tags.push(p),i[a]=p}i[a].addElement(u)}else this.tags.push(new s(u))}this.flowManager=new o({fmReference:this,tags:this.tags}).start()},h.prototype.buildUI=function(){this.el=document.createElement("div"),this.el.id="form-messenger",this.containerEl.appendChild(this.el),this.chatEl=new l(this),this.el.appendChild(this.chatEl.el),this.bubbleEl=new u(this),this.el.appendChild(this.bubbleEl.el),this.userInput=new a(this),this.el.appendChild(this.userInput.el)},h.prototype.onFlowUpdate=function(t){var e=t.detail,i=e.getQuestion().split(this.options.previousResponsePattern).join(this.currentResponse);this.chatEl.buildBotChatElement(i),this.userInput.reset(),e instanceof s?(this.userInput.hideUserInput(e.isInputSensitive()),this.userInput.setPlaceHolder(e.getPlaceHolder()),this.userInput.focusInputBox()):e instanceof r&&this.userInput.setPlaceHolder("Search"),this.bubbleEl.prePopulateBubble(e),this.processing=!1},h.prototype.doSubmitForm=function(){if(this.formCompleteCallback&&"function"==typeof this.formCompleteCallback)this.formCompleteCallback();else{this.chatEl.buildBotChatElement("Sending form..."),this.userInput.setDisabled(!0);var t=[].slice.call(this.formEl.querySelectorAll("input, button"),0);if(t.length>0)for(var e=0;e<t.length;e++)"submit"==t[e].getAttribute("type")&&t[e].click();else this.formEl.submit()}},h.prototype.setCurrentResponse=function(t){this.userInput.clearInput(),this.currentResponse=t},h.prototype.onUserInputError=function(t){this.chatEl.buildBotChatElement(t.detail,!0),this.processing=!1},h.prototype.setFormSelection=function(t,e){var e=e||"Which do you want to proceed?";this.chatEl.buildBotChatElement(e);var i=[];for(var n in t)i.push({label:n,value:t[n],isFormSelection:!0});this.bubbleEl.renderBubbles(i)},t.FormMessenger=h}(fm||(fm={}));var FormMessenger=fm.FormMessenger;window.addEventListener("load",function(){var t=document.querySelector("#fm-initiator"),e=document.querySelector("#fm-container");t&&(window.FormMessenger=new FormMessenger({formEl:t,containerEl:e}))});