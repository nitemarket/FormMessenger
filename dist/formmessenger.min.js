var fm;!function(t){"use strict";var e={chatListClass:"",chatElementClass:"",bubbleListClass:"",bubbleElementClass:"",inputContainerClass:"",inputBoxClass:"",inputButtonClass:"",previousResponsePattern:"{{previousResponse}}",formCompleteCallback:null,formSubmissionText:null,formValidation:{email:function(t){/^\w+([\.\-]?\ w+)*@\w+([\.\-]?\ w+)*(\.\w{2,3})+$/.test(t)||this.setErrorAndReply("Please provide a valid email.")},password:function(t){/(?=.*\d)(?=.*[a-z]).{6,}/.test(t)||this.setErrorAndReply("Password must contain one number, one lowercase and at least 6 in length.")},interest:function(t){t instanceof Array&&t.length<1&&this.setErrorAndReply("Please select at least one.")}}},n={userInputSubmit:"fm-user-input-submit",userInputUpdate:"fm-user-input-update",userInputKeyChange:"fm-user-input-key-change",onBubbleClick:"fm-on-bubble-click",onUserInputError:"fm-user-input-error",flowUpdate:"fm-flow-update"},i={tagNameRequest:"Please provide us your {tagName}",formSelectionQuestion:"Which do you want to proceed?",formYesNoQuestion:"Would you like to proceed to {label}",notAvailableResponse:"Not available"},s={},o=function(t){};o.isTagValid=function(t){return!t.hasAttribute("fm-disabled")&&(!(["hidden","submit","button"].indexOf(t.getAttribute("type"))>=0)&&(!(["true","disabled"].indexOf(t.getAttribute("disabled"))>=0)&&"button"!=t.tagName))},o.isTagGroup=function(t){return["radio","checkbox"].indexOf(t.getAttribute("type"))>=0};var r=function(t){o.call(this),this.element=t};r.prototype=Object.create(o.prototype),r.prototype.constructor=r,r.prototype.getAttrName=function(){return this.element.getAttribute("name")},r.prototype.setInputValue=function(t){var e=this.getAttrName();s.hasOwnProperty(e)||(s[e]=[]),s[e].indexOf(t)<=-1&&s[e].push(t),this.element.value=t},r.prototype.isInputSensitive=function(){return"password"==this.element.getAttribute("type")},r.prototype.getPlaceHolder=function(){return this.element.getAttribute("placeholder")},r.prototype.getBubbles=function(){var t=[],e=this.getCacheBubbles();return this.element.value&&e.indexOf(this.element.value)<=-1&&e.push(this.element.value),e&&e.forEach(function(e){t.push({value:e,label:e})}),t},r.prototype.getQuestion=function(){return(!this.questions||this.questions.length<=0)&&(this.questions=[],this.element&&this.element.getAttribute("fm-questions")&&(this.questions=this.element.getAttribute("fm-questions").split("|")),this.questions.length<=0&&this.questions.push(i.tagNameRequest.replace("{tagName}",this.element.getAttribute("name")))),this.questions[Math.floor(Math.random()*this.questions.length)].trim()},r.prototype.getCacheBubbles=function(){var t=this.getAttrName();return s.hasOwnProperty(t)?s[t]:[]};var l=function(t,e){o.call(this),this.attrName=t,this.type=e,this.elements=[]};l.prototype=Object.create(o.prototype),l.prototype.constructor=l,l.prototype.getAttrName=function(){return this.attrName},l.prototype.addElement=function(t){this.elements.push(t)},l.prototype.setInputValue=function(t,e){this.elements.forEach(function(n){n.getAttribute("value")==t&&(n.checked=e)})},l.prototype.getQuestion=function(){var t=this;return(!this.questions||this.questions.length<=0)&&(this.questions=[],this.elements.some(function(e){var n=e.getAttribute("fm-questions");if(n)return t.questions=n.split("|"),!0}),this.questions.length<=0&&this.questions.push(i.tagNameRequest.replace("{tagName}",this.attrName))),this.questions[Math.floor(Math.random()*this.questions.length)].trim()},l.prototype.getBubbles=function(){var t=[];return this.elements.forEach(function(e){t.push({value:e.value,label:e.getAttribute("fm-label")||e.value,isChecked:e.checked})}),t},l.prototype.getCheckedValuesForMsg=function(){var t=[];return this.elements.forEach(function(e){if(e.checked){var n=e.getAttribute("fm-label")||e.value;t.push(n)}}),t};var u=function(t){return this.step=0,this.maxSteps=t.tags.length,this.tags=t.tags,this.fmReference=t.fmReference,this.repeatStep=!1,this.userInputSubmitCallback=this.userInputSubmit.bind(this),document.addEventListener(n.userInputSubmit,this.userInputSubmitCallback,!1),this.onBubbleClickCallback=this.onBubbleClick.bind(this),document.addEventListener(n.onBubbleClick,this.onBubbleClickCallback,!1),this};Object.defineProperty(u.prototype,"currentTag",{get:function(){return this.tags[this.step]},enumerable:!0,configurable:!0}),u.prototype.start=function(){return this.processStep(),this},u.prototype.nextStep=function(){this.step++,this.processStep()},u.prototype.processStep=function(){this.step==this.maxSteps?this.fmReference.doSubmitForm():(this.step%=this.maxSteps,this.showStep())},u.prototype.showStep=function(){var t=this;document.dispatchEvent(new CustomEvent(n.flowUpdate,{detail:t.currentTag}))},u.prototype.userInputSubmit=function(t){var e,i,s=this;if(this.repeatStep=!1,console.log(this.tags),console.log(this.step),this.fmReference.isProcessing())return!1;if(this.fmReference.setProcessing(!0),this.currentTag instanceof r){if(e=t.detail.value,i=e.trim(),this.currentTag.setInputValue(i),this.currentTag.isInputSensitive()){for(var o="",u=0;u<i.length;u++)o+="*";i=o}}else this.currentTag instanceof l&&(e=this.currentTag.getCheckedValuesForMsg(),i=e.join(", "));document.dispatchEvent(new CustomEvent(n.userInputUpdate,{detail:i})),this.validateInput(e)&&!this.repeatStep&&setTimeout(function(){return s.nextStep()},250)},u.prototype.onBubbleClick=function(t){var e=t.detail.value,n=t.detail.isChecked;this.currentTag instanceof r?this.userInputSubmit(t):this.currentTag instanceof l&&(this.currentTag.setInputValue(e,n),"radio"==this.currentTag.type&&this.userInputSubmit(t))},u.prototype.validateInput=function(t){var e=this.currentTag.getAttrName();return this.fmReference.options.formValidation.hasOwnProperty(e)&&this.fmReference.options.formValidation[e].call(this,t),!0},u.prototype.setErrorAndReply=function(t){this.repeatStep=!0,document.dispatchEvent(new CustomEvent(n.onUserInputError,{detail:t}))},u.prototype.removeEventListener=function(){console.log("remove listener"),document.removeEventListener(n.userInputSubmit,this.userInputSubmitCallback,!1),this.userInputSubmitCallback=null,document.removeEventListener(n.onBubbleClick,this.onBubbleClickCallback,!1),this.onBubbleClickCallback=null};var a=function(t){return this.fmReference=t,this.el=document.createElement("div"),this.el.id="fmChatList",this.el.className=this.fmReference.options.chatListClass.trim(),this.onUserInputUpdateCallback=this.onUserInputUpdate.bind(this),document.addEventListener(n.userInputUpdate,this.onUserInputUpdateCallback,!1),this};a.prototype.onUserInputUpdate=function(t){this.buildUserChatElement(t.detail),this.fmReference.setCurrentResponse(t.detail)},a.prototype.buildUserChatElement=function(t){var e=t||i.notAvailableResponse,n=document.createElement("div");n.className=("fm-chat-element fm-user fm-clearfix "+this.fmReference.options.chatElementClass).trim(),n.textContent=e,t||(n.className+=" skip"),this.el.appendChild(n),this.scrollToBottom()},a.prototype.buildBotChatElement=function(t,e){if(t){var n=document.createElement("div");n.className=("fm-chat-element fm-bot fm-clearfix "+this.fmReference.options.chatElementClass).trim(),n.textContent=t,"error"==e?n.className+=" error":"info"==e&&(n.className+=" info"),this.el.appendChild(n),this.scrollToBottom()}},a.prototype.scrollToBottom=function(){this.el.scrollTop=this.el.scrollHeight-this.el.clientHeight};var h=function(t){return this.fmReference=t,this.bubbles=[],this.el=document.createElement("div"),this.el.id="fmBubbleList",this.el.className=this.fmReference.options.bubbleListClass.trim(),this.userInputKeyChangeCallback=this.userInputKeyChange.bind(this),document.addEventListener(n.userInputKeyChange,this.userInputKeyChangeCallback,!1),this};h.prototype.userInputKeyChange=function(t){if(this.bubbles.length>0){var e=[];t.detail?this.bubbles.forEach(function(n){t.detail&&n.label.toLowerCase().indexOf(t.detail.toLowerCase())!==-1&&e.push(n)}):e=this.bubbles,this.renderBubbles(e)}},h.prototype.prePopulateInputBubble=function(t){this.bubbles=t.getBubbles(),this.renderBubbles()},h.prototype.prePopulateLinkBubble=function(t){this.bubbles=t,this.renderBubbles()},h.prototype.clearBubbles=function(){this.bubbles=[],this.renderBubbles()},h.prototype.renderBubbles=function(t){for(var e=this,t=t||this.bubbles;this.el.hasChildNodes();)this.el.removeChild(this.el.lastChild);t.length>0&&t.forEach(function(t){var n=document.createElement("div");n.className=("fm-bubble-element "+e.fmReference.options.bubbleElementClass).trim(),n.textContent=t.label,t.isChecked&&(n.className+=" selected"),e.el.appendChild(n),t.isFormSelection||t.isFormYes?n.addEventListener("click",function(){e.handleFormSelectionClick.call(e,t)},!1):t.isFormNo?t.hasOwnProperty("callback")&&"function"==typeof t.callback&&n.addEventListener("click",function(){e.handleFormNo.call(e,t)},!1):n.addEventListener("click",function(){e.handleBubbleClick.call(this,t.value)},!1)})},h.prototype.handleBubbleClick=function(t){this.classList.toggle("selected"),document.dispatchEvent(new CustomEvent(n.onBubbleClick,{detail:{value:t,isChecked:this.classList.contains("selected")}}))},h.prototype.onBubbleLinkClick=function(t){return!this.fmReference.isProcessing()&&(this.fmReference.setProcessing(!0),void document.dispatchEvent(new CustomEvent(n.userInputUpdate,{detail:t.label})))},h.prototype.handleFormSelectionClick=function(t){var e=this;this.onBubbleLinkClick(t),setTimeout(function(){e.fmReference.initForm(t.value)},250)},h.prototype.handleFormNo=function(t){var e=this;this.onBubbleLinkClick(t),setTimeout(function(){t.callback.call(e.fmReference),e.fmReference.setProcessing(!1)},250)};var p=function(t){return this.fmReference=t,this.disabled=!1,this.referCurrentResponse=!0,this.el=document.createElement("div"),this.el.id="fmInputContainer",this.el.className=this.fmReference.options.inputContainerClass.trim(),this.inputEl=document.createElement("input"),this.inputEl.type="text",this.inputEl.id="fmInputBox",this.inputEl.className=this.fmReference.options.inputBoxClass.trim(),this.inputBtnEl=document.createElement("button"),this.inputBtnEl.type="button",this.inputBtnEl.id="fmInputBtn",this.inputBtnEl.innerHTML="Send",this.inputBtnEl.className=this.fmReference.options.inputButtonClass.trim(),this.el.appendChild(this.inputEl),this.el.appendChild(this.inputBtnEl),this.onKeyUpCallback=this.onKeyUp.bind(this),this.inputEl.addEventListener("keyup",this.onKeyUpCallback,!1),this.onEnterOrSubmitBtnCallback=this.onEnterOrSubmitBtn.bind(this),this.inputBtnEl.addEventListener("click",this.onEnterOrSubmitBtnCallback,!1),this};p.prototype.onKeyUp=function(t){var e=this;return!this.disabled&&void(13==t.keyCode?this.onEnterOrSubmitBtn():38==t.keyCode&&this.referCurrentResponse?this.inputEl.value=this.fmReference.currentResponse:document.dispatchEvent(new CustomEvent(n.userInputKeyChange,{detail:e.inputEl.value})))},p.prototype.onEnterOrSubmitBtn=function(){return!this.disabled&&void document.dispatchEvent(new CustomEvent(n.userInputSubmit,{detail:{value:this.inputEl.value}}))},p.prototype.hideUserInput=function(t){t?(this.referCurrentResponse=!1,this.inputEl.setAttribute("type","password")):this.inputEl.setAttribute("type","text")},p.prototype.setPlaceHolder=function(t){this.inputEl.setAttribute("placeholder",t)},p.prototype.focusInputBox=function(){this.inputEl.focus()},p.prototype.clearInput=function(){this.inputEl.value=""},p.prototype.setDisabled=function(t){this.disabled=!!t,t?(this.inputEl.setAttribute("disabled","disabled"),this.inputBtnEl.setAttribute("disabled","disabled")):(this.inputEl.removeAttribute("disabled"),this.inputBtnEl.removeAttribute("disabled"))},p.prototype.reset=function(){this.referCurrentResponse=!0,this.inputBtnEl.innerHTML="Send",this.setDisabled(!1),this.clearInput()},p.prototype.setInputBtnLabel=function(t){this.inputBtnEl.innerHTML=t};var c=function(t){if(!t.formEl&&!t.formSelection)throw new Error("Conversational Form error, Invalid formEl.");var i=this;this.options=Object.assign({},e,t),this.formEl=t.formEl,this.containerEl=t.containerEl?t.containerEl:document.body,this.tags=[],this.currentResponse="",this.processing=!1,this.buildUI(),this.onFlowUpdateCallback=this.onFlowUpdate.bind(this),document.addEventListener(n.flowUpdate,this.onFlowUpdateCallback,!1),this.onUserInputErrorCallback=this.onUserInputError.bind(this),document.addEventListener(n.onUserInputError,this.onUserInputErrorCallback,!1),this.formEl?(this.formEl.setAttribute("novalidate",""),setTimeout(function(){return i.initForm(i.formEl)},0)):t.formSelection&&this.setFormSelection(t.formSelection,t.formSelectionQuestion)};c.prototype.isProcessing=function(){return this.processing===!0},c.prototype.setProcessing=function(t){this.processing=t},c.prototype.reset=function(){this.tags=[],this.currentResponse="",this.processing=!1},c.prototype.initForm=function(t){this.formEl=t,this.reset();for(var e=[].slice.call(this.formEl.querySelectorAll("input, button"),0),n={},i=0;i<e.length;i++){var s=e[i];if(o.isTagValid(s))if(o.isTagGroup(s)){var a=s.getAttribute("name"),h=s.getAttribute("type");if(!n.hasOwnProperty(a)){var p=new l(a,h);this.tags.push(p),n[a]=p}n[a].addElement(s)}else this.tags.push(new r(s))}this.flowManager&&this.flowManager.removeEventListener(),this.flowManager=new u({fmReference:this,tags:this.tags}).start()},c.prototype.buildUI=function(){this.el=document.createElement("div"),this.el.id="form-messenger",this.containerEl.appendChild(this.el),this.chatEl=new a(this),this.el.appendChild(this.chatEl.el),this.bubbleEl=new h(this),this.el.appendChild(this.bubbleEl.el),this.userInput=new p(this),this.el.appendChild(this.userInput.el)},c.prototype.onFlowUpdate=function(t){var e=t.detail,n=e.getQuestion().split(this.options.previousResponsePattern).join(this.currentResponse);this.chatEl.buildBotChatElement(n),this.userInput.reset(),e instanceof r?(this.userInput.hideUserInput(e.isInputSensitive()),this.userInput.setPlaceHolder(e.getPlaceHolder()),this.userInput.focusInputBox()):e instanceof l&&this.userInput.setPlaceHolder("Search"),this.bubbleEl.prePopulateInputBubble(e),this.setProcessing(!1)},c.prototype.doSubmitForm=function(){if(this.formCompleteCallback&&"function"==typeof this.formCompleteCallback)this.formCompleteCallback.call(this);else{this.options.formSubmissionText&&this.chatEl.buildBotChatElement(this.options.formSubmissionText),this.userInput.setDisabled(!0);var t=[].slice.call(this.formEl.querySelectorAll("input, button"),0);if(t.length>0)for(var e=0;e<t.length;e++)"submit"==t[e].getAttribute("type")&&t[e].click();else this.formEl.submit()}this.setProcessing(!1)},c.prototype.setCurrentResponse=function(t){this.userInput.clearInput(),this.currentResponse=t},c.prototype.onUserInputError=function(t){this.chatEl.buildBotChatElement(t.detail,"error"),this.setProcessing(!1)},c.prototype.setFormSelection=function(t,e){this.userInput.reset();var e=e||i.formSelectionQuestion;this.chatEl.buildBotChatElement(e);var n=[];for(var s in t)n.push({label:s,value:t[s],isFormSelection:!0});this.bubbleEl.prePopulateLinkBubble(n)},c.prototype.setFormYesNo=function(t,e,n){this.userInput.reset();var e=e||i.formYesNoQuestion.repeat("{label}",t.label);this.chatEl.buildBotChatElement(e);var s=[];s.push({label:"Yes",value:t.elem,isFormYes:!0}),s.push({label:"No",value:null,callback:n,isFormNo:!0}),this.bubbleEl.prePopulateLinkBubble(s)},c.prototype.setErrorResponse=function(t){this.chatEl.buildBotChatElement(t,"error")},c.prototype.setInfoResponse=function(t){this.chatEl.buildBotChatElement(t,"info")},t.FormMessenger=c}(fm||(fm={}));var FormMessenger=fm.FormMessenger;window.addEventListener("load",function(){var t=document.querySelector("#fm-initiator"),e=document.querySelector("#fm-container");t&&(window.FormMessenger=new FormMessenger({formEl:t,containerEl:e}))});