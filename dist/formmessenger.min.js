var fm;!function(t){"use strict";var e={chatListClass:"",chatElementClass:"",bubbleListClass:"",bubbleElementClass:"",inputContainerClass:"",inputBoxClass:"",inputButtonClass:"",previousResponsePattern:"{{previousResponse}}",humanized:!0,speedPerCharacter:25,greetingText:null,formCompleteCallback:null,formSubmissionText:null,formValidation:{email:function(t){/^\w+([\.\-]?\ w+)*@\w+([\.\-]?\ w+)*(\.\w{2,3})+$/.test(t)||this.setErrorAndReply("Please provide a valid email.")},password:function(t){/(?=.*\d)(?=.*[a-z]).{6,}/.test(t)||this.setErrorAndReply("Password must contain one number, one lowercase and at least 6 in length.")},interest:function(t){t instanceof Array&&t.length<1&&this.setErrorAndReply("Please select at least one.")}}},i={userInputSubmit:"fm-user-input-submit",userInputUpdate:"fm-user-input-update",userInputKeyChange:"fm-user-input-key-change",onBubbleClick:"fm-on-bubble-click",onUserInputError:"fm-user-input-error",flowUpdate:"fm-flow-update"},n={tagNameRequest:"Please provide us your {tagName}",formSelectionQuestion:"Which do you want to proceed?",formYesNoQuestion:"Would you like to proceed to {label}",notAvailableResponse:"Not available"},s=function(t){this.fmReference=t};s.prototype.calculateTypingSpeed=function(t){return t.length*this.fmReference.options.speedPerCharacter};var o=function(t){this.fmReference=t,this.inputCache={}};o.prototype.store=function(t,e){this.inputCache.hasOwnProperty(t)||(this.inputCache[t]=[]),this.inputCache[t].indexOf(e)<=-1&&this.inputCache[t].push(e)},o.prototype.retrieve=function(t){return this.inputCache.hasOwnProperty(t)?this.inputCache[t]:[]};var r=function(t){};r.isTagValid=function(t){return!t.hasAttribute("fm-disabled")&&(!(["hidden","submit","button"].indexOf(t.getAttribute("type"))>=0)&&(!(["true","disabled"].indexOf(t.getAttribute("disabled"))>=0)&&"button"!=t.tagName))},r.isTagGroup=function(t){return["radio","checkbox"].indexOf(t.getAttribute("type"))>=0};var l=function(t){r.call(this),this.element=t};l.prototype=Object.create(r.prototype),l.prototype.constructor=l,l.prototype.getAttrName=function(){return this.element.getAttribute("name")},l.prototype.setInputValue=function(t){this.element.value=t},l.prototype.isInputSensitive=function(){return!("password"!=this.element.getAttribute("type")&&!this.element.hasAttribute("fm-sensitive"))},l.prototype.getPlaceHolder=function(){return this.element.getAttribute("placeholder")},l.prototype.getBubbles=function(t){var e=[];if(!this.element.hasAttribute("fm-nobubble")&&!this.isInputSensitive()){var i=t.retrieve(this.getAttrName());this.element.value&&i.indexOf(this.element.value)<=-1&&i.push(this.element.value),i&&i.forEach(function(t){e.push({value:t,label:t})})}return e},l.prototype.getQuestion=function(){return(!this.questions||this.questions.length<=0)&&(this.questions=[],this.element&&this.element.getAttribute("fm-questions")&&(this.questions=this.element.getAttribute("fm-questions").split("|")),this.questions.length<=0&&this.questions.push(n.tagNameRequest.replace("{tagName}",this.element.getAttribute("name")))),this.questions[Math.floor(Math.random()*this.questions.length)].trim()};var u=function(t,e){r.call(this),this.attrName=t,this.type=e,this.elements=[]};u.prototype=Object.create(r.prototype),u.prototype.constructor=u,u.prototype.getAttrName=function(){return this.attrName},u.prototype.addElement=function(t){this.elements.push(t)},u.prototype.setInputValue=function(t,e){this.elements.forEach(function(i){i.getAttribute("value")==t&&(i.checked=e)})},u.prototype.getQuestion=function(){var t=this;return(!this.questions||this.questions.length<=0)&&(this.questions=[],this.elements.some(function(e){var i=e.getAttribute("fm-questions");if(i)return t.questions=i.split("|"),!0}),this.questions.length<=0&&this.questions.push(n.tagNameRequest.replace("{tagName}",this.attrName))),this.questions[Math.floor(Math.random()*this.questions.length)].trim()},u.prototype.getBubbles=function(t){var e=[];return this.elements.forEach(function(t){e.push({value:t.value,label:t.getAttribute("fm-label")||t.value,isChecked:t.checked})}),e},u.prototype.getCheckedValuesForMsg=function(){var t=[];return this.elements.forEach(function(e){if(e.checked){var i=e.getAttribute("fm-label")||e.value;t.push(i)}}),t};var a=function(t){return this.step=0,this.maxSteps=t.tags.length,this.tags=t.tags,this.fmReference=t.fmReference,this.repeatStep=!1,this.userInputSubmitCallback=this.userInputSubmit.bind(this),document.addEventListener(i.userInputSubmit,this.userInputSubmitCallback,!1),this.onBubbleClickCallback=this.onBubbleClick.bind(this),document.addEventListener(i.onBubbleClick,this.onBubbleClickCallback,!1),this};Object.defineProperty(a.prototype,"currentTag",{get:function(){return this.tags[this.step]},enumerable:!0,configurable:!0}),a.prototype.start=function(){return this.processStep(),this},a.prototype.nextStep=function(){this.step++,this.processStep()},a.prototype.processStep=function(){this.step==this.maxSteps?this.fmReference.doSubmitForm():(this.step%=this.maxSteps,this.showStep())},a.prototype.showStep=function(){var t=this;document.dispatchEvent(new CustomEvent(i.flowUpdate,{detail:t.currentTag}))},a.prototype.userInputSubmit=function(t){var e,n,s=this;if(this.repeatStep=!1,this.fmReference.isProcessing())return!1;if(this.fmReference.setProcessing(!0),this.currentTag instanceof l)if(e=t.detail.value,n=e.trim(),this.currentTag.setInputValue(n),this.currentTag.isInputSensitive()){for(var o="",r=0;r<n.length;r++)o+="*";n=o}else this.fmReference.globalBubble.store(this.currentTag.getAttrName(),n);else this.currentTag instanceof u&&(e=this.currentTag.getCheckedValuesForMsg(),n=e.join(", "));document.dispatchEvent(new CustomEvent(i.userInputUpdate,{detail:n})),this.validateInput(e)&&!this.repeatStep&&setTimeout(function(){return s.nextStep()},250)},a.prototype.onBubbleClick=function(t){var e=t.detail.value;this.currentTag instanceof l?this.userInputSubmit(t):this.currentTag instanceof u&&("radio"==this.currentTag.type?(this.currentTag.setInputValue(e,!0),this.userInputSubmit(t)):this.currentTag.setInputValue(e,t.detail.isChecked))},a.prototype.validateInput=function(t){var e=this.currentTag.getAttrName();return this.fmReference.options.formValidation.hasOwnProperty(e)&&this.fmReference.options.formValidation[e].call(this,t),!0},a.prototype.setErrorAndReply=function(t){this.repeatStep=!0,document.dispatchEvent(new CustomEvent(i.onUserInputError,{detail:t}))},a.prototype.removeEventListener=function(){document.removeEventListener(i.userInputSubmit,this.userInputSubmitCallback,!1),this.userInputSubmitCallback=null,document.removeEventListener(i.onBubbleClick,this.onBubbleClickCallback,!1),this.onBubbleClickCallback=null};var h=function(t){return this.fmReference=t,this.humanized=t.options.humanized,this.el=document.createElement("div"),this.el.id="fmChatList",this.el.className=this.fmReference.options.chatListClass.trim(),this.onUserInputUpdateCallback=this.onUserInputUpdate.bind(this),document.addEventListener(i.userInputUpdate,this.onUserInputUpdateCallback,!1),this};h.prototype.onUserInputUpdate=function(t){this.buildUserChatElement(t.detail),this.fmReference.setCurrentResponse(t.detail)},h.prototype.buildUserChatElement=function(t){var e=t||n.notAvailableResponse,i=document.createElement("div");i.className=("fm-chat-element fm-user fm-clearfix "+this.fmReference.options.chatElementClass).trim(),i.textContent=e,t||(i.className+=" skip"),this.el.appendChild(i),this.scrollToBottom()},h.prototype.buildBotChatElement=function(t,e){if(t){var i,n,s=this;"function"==typeof arguments[1]?i=arguments[1]:(n=arguments[1],i=arguments[2]);var o=document.createElement("div");o.className=("fm-chat-element fm-bot fm-clearfix "+this.fmReference.options.chatElementClass).trim(),this.humanized?(o.textContent="...",setTimeout(function(){o.textContent=t,n&&(o.className+=" "+n),i&&"function"==typeof i&&i.call(s.fmReference)},this.fmReference.util.calculateTypingSpeed(t))):(n&&(o.className+=" "+n),o.textContent=t,i&&"function"==typeof i&&i.call(s.fmReference)),this.el.appendChild(o),this.scrollToBottom()}},h.prototype.scrollToBottom=function(){this.el.scrollTop=this.el.scrollHeight-this.el.clientHeight};var p=function(t){return this.fmReference=t,this.bubbles=[],this.toggleable=!1,this.el=document.createElement("div"),this.el.id="fmBubbleList",this.el.className=this.fmReference.options.bubbleListClass.trim(),this.userInputKeyChangeCallback=this.userInputKeyChange.bind(this),document.addEventListener(i.userInputKeyChange,this.userInputKeyChangeCallback,!1),this};p.prototype.userInputKeyChange=function(t){if(this.bubbles.length>0){var e=[];t.detail?this.bubbles.forEach(function(i){t.detail&&i.label.toLowerCase().indexOf(t.detail.toLowerCase())!==-1&&e.push(i)}):e=this.bubbles,this.renderBubbles(e)}},p.prototype.prePopulateInputBubble=function(t,e){this.reset(),this.bubbles=t.getBubbles(e),"checkbox"==t.type&&(this.toggleable=!0),this.renderBubbles()},p.prototype.prePopulateLinkBubble=function(t){this.reset(),this.bubbles=t,this.renderBubbles()},p.prototype.clearBubbles=function(){this.reset(),this.bubbles=[],this.renderBubbles()},p.prototype.renderBubbles=function(t){for(var e=this,t=t||this.bubbles;this.el.hasChildNodes();)this.el.removeChild(this.el.lastChild);t.length>0&&t.forEach(function(t){var i=document.createElement("div");i.className=("fm-bubble-element "+e.fmReference.options.bubbleElementClass).trim(),i.textContent=t.label,t.isChecked&&(i.className+=" selected"),e.toggleable&&(i.className+=" checkbox"),e.el.appendChild(i),t.isFormSelection||t.isFormYes?i.addEventListener("click",function(){e.handleFormSelectionClick.call(e,t)},!1):t.isFormNo?t.hasOwnProperty("callback")&&"function"==typeof t.callback&&i.addEventListener("click",function(){e.handleFormNo.call(e,t)},!1):i.addEventListener("click",function(){e.handleBubbleClick.call(this,t.value,e)},!1)})},p.prototype.handleBubbleClick=function(t,e){e.toggleable?this.classList.toggle("selected"):([].forEach.call(e.el.childNodes,function(t){t.classList.remove("selected")}),this.classList.add("selected")),document.dispatchEvent(new CustomEvent(i.onBubbleClick,{detail:{value:t,isChecked:this.classList.contains("selected")}}))},p.prototype.onBubbleLinkClick=function(t){return!this.fmReference.isProcessing()&&(this.fmReference.setProcessing(!0),void document.dispatchEvent(new CustomEvent(i.userInputUpdate,{detail:t.label})))},p.prototype.handleFormSelectionClick=function(t){var e=this;this.onBubbleLinkClick(t),setTimeout(function(){e.fmReference.initForm(t.value)},250)},p.prototype.handleFormNo=function(t){var e=this;this.onBubbleLinkClick(t),setTimeout(function(){t.callback.call(e.fmReference),e.fmReference.setProcessing(!1)},250)},p.prototype.reset=function(){this.toggleable=!1};var c=function(t){return this.fmReference=t,this.disabled=!1,this.referCurrentResponse=!0,this.el=document.createElement("div"),this.el.id="fmInputContainer",this.el.className=this.fmReference.options.inputContainerClass.trim(),this.inputEl=document.createElement("input"),this.inputEl.type="text",this.inputEl.id="fmInputBox",this.inputEl.className=this.fmReference.options.inputBoxClass.trim(),this.inputBtnEl=document.createElement("button"),this.inputBtnEl.type="button",this.inputBtnEl.id="fmInputBtn",this.inputBtnEl.innerHTML="Send",this.inputBtnEl.className=this.fmReference.options.inputButtonClass.trim(),this.el.appendChild(this.inputEl),this.el.appendChild(this.inputBtnEl),this.onKeyUpCallback=this.onKeyUp.bind(this),this.inputEl.addEventListener("keyup",this.onKeyUpCallback,!1),this.onEnterOrSubmitBtnCallback=this.onEnterOrSubmitBtn.bind(this),this.inputBtnEl.addEventListener("click",this.onEnterOrSubmitBtnCallback,!1),this};c.prototype.onKeyUp=function(t){var e=this;return!this.disabled&&void(13==t.keyCode?this.onEnterOrSubmitBtn():38==t.keyCode&&this.referCurrentResponse?this.inputEl.value=this.fmReference.currentResponse:document.dispatchEvent(new CustomEvent(i.userInputKeyChange,{detail:e.inputEl.value})))},c.prototype.onEnterOrSubmitBtn=function(){return!this.disabled&&void document.dispatchEvent(new CustomEvent(i.userInputSubmit,{detail:{value:this.inputEl.value}}))},c.prototype.hideUserInput=function(t){t?(this.referCurrentResponse=!1,this.inputEl.setAttribute("type","password")):this.inputEl.setAttribute("type","text")},c.prototype.setPlaceHolder=function(t){this.inputEl.setAttribute("placeholder",t)},c.prototype.focusInputBox=function(){this.inputEl.focus()},c.prototype.clearInput=function(){this.inputEl.value=""},c.prototype.setDisabled=function(t){this.disabled=!!t,t?(this.inputEl.setAttribute("disabled","disabled"),this.inputBtnEl.setAttribute("disabled","disabled")):(this.inputEl.removeAttribute("disabled"),this.inputBtnEl.removeAttribute("disabled"))},c.prototype.reset=function(){this.referCurrentResponse=!0,this.inputBtnEl.innerHTML="Send",this.setDisabled(!1)},c.prototype.setInputBtnLabel=function(t){this.inputBtnEl.innerHTML=t};var m=function(t){if(!t.formEl&&!t.formSelection)throw new Error("Conversational Form error, Invalid formEl.");var n=this;this.options=Object.assign({},e,t),this.formEl=t.formEl,this.containerEl=t.containerEl?t.containerEl:document.body,this.util=new s(this),this.tags=[],this.currentResponse="",this.processing=!1,this.globalBubble=new o(this),this.buildUI(),this.onFlowUpdateCallback=this.onFlowUpdate.bind(this),document.addEventListener(i.flowUpdate,this.onFlowUpdateCallback,!1),this.onUserInputErrorCallback=this.onUserInputError.bind(this),document.addEventListener(i.onUserInputError,this.onUserInputErrorCallback,!1);var r=function(){return this.formEl?(this.formEl.setAttribute("novalidate",""),n.initForm(n.formEl)):void(t.formSelection&&n.setFormSelection(t.formSelection,t.formSelectionQuestion))},l=function(t,e,i,s){var o=t[e];if(e++,e<t.length)var r=function(){l(t,e,null,s)};else r=s;n.setResponseWithClass(o,"greeting",r)};this.options.greetingText?Array.isArray(this.options.greetingText)?l(this.options.greetingText,0,null,r):"string"==typeof this.options.greetingText&&this.setResponseWithClass(this.options.greetingText,"greeting",r):setTimeout(function(){r.call(this)},0)};m.prototype.isProcessing=function(){return this.processing===!0},m.prototype.setProcessing=function(t){this.processing=t},m.prototype.reset=function(){this.tags=[],this.currentResponse="",this.processing=!1},m.prototype.initForm=function(t){this.formEl=t,this.reset();for(var e=[].slice.call(this.formEl.querySelectorAll("input, button"),0),i={},n=0;n<e.length;n++){var s=e[n];if(r.isTagValid(s))if(r.isTagGroup(s)){var o=s.getAttribute("name"),h=s.getAttribute("type");if(!i.hasOwnProperty(o)){var p=new u(o,h);this.tags.push(p),i[o]=p}i[o].addElement(s)}else this.tags.push(new l(s))}this.flowManager&&this.flowManager.removeEventListener(),this.flowManager=new a({fmReference:this,tags:this.tags}).start()},m.prototype.buildUI=function(){this.el=document.createElement("div"),this.el.id="form-messenger",this.containerEl.appendChild(this.el),this.chatEl=new h(this),this.el.appendChild(this.chatEl.el),this.bubbleEl=new p(this),this.el.appendChild(this.bubbleEl.el),this.userInput=new c(this),this.el.appendChild(this.userInput.el)},m.prototype.onFlowUpdate=function(t){var e=t.detail,i=e.getQuestion().split(this.options.previousResponsePattern).join(this.currentResponse);this.chatEl.buildBotChatElement(i,function(){this.userInput.reset(),e instanceof l?(this.userInput.hideUserInput(e.isInputSensitive()),this.userInput.setPlaceHolder(e.getPlaceHolder()),this.userInput.focusInputBox()):e instanceof u&&this.userInput.setPlaceHolder("Search"),this.bubbleEl.prePopulateInputBubble(e,this.globalBubble),this.setProcessing(!1)})},m.prototype.doSubmitForm=function(){if(this.formCompleteCallback&&"function"==typeof this.formCompleteCallback)this.formCompleteCallback.call(this);else{this.userInput.setDisabled(!0);var t=function(){var t=[].slice.call(this.formEl.querySelectorAll("input, button"),0);if(t.length>0)for(var e=0;e<t.length;e++)"submit"==t[e].getAttribute("type")&&t[e].click();else this.formEl.submit()};this.options.formSubmissionText?this.chatEl.buildBotChatElement(this.options.formSubmissionText,t):t.call(this)}this.setProcessing(!1)},m.prototype.setCurrentResponse=function(t){this.userInput.clearInput(),this.currentResponse=t},m.prototype.onUserInputError=function(t){this.chatEl.buildBotChatElement(t.detail,"error",function(){this.setProcessing(!1)})},m.prototype.setFormSelection=function(t,e){this.userInput.reset();var e=e||n.formSelectionQuestion;this.chatEl.buildBotChatElement(e,function(){var e=[];for(var i in t)e.push({label:i,value:t[i],isFormSelection:!0});this.bubbleEl.prePopulateLinkBubble(e)})},m.prototype.setFormYesNo=function(t,e,i){this.userInput.reset();var e=e||n.formYesNoQuestion.repeat("{label}",t.label);this.chatEl.buildBotChatElement(e,function(){var e=[];e.push({label:"Yes",value:t.elem,isFormYes:!0}),e.push({label:"No",value:null,callback:i,isFormNo:!0}),this.bubbleEl.prePopulateLinkBubble(e)})},m.prototype.setErrorResponse=function(t,e){this.setResponseWithClass(t,"error",e)},m.prototype.setInfoResponse=function(t,e){this.setResponseWithClass(t,"info",e)},m.prototype.setResponseWithClass=function(t,e,i){this.chatEl.buildBotChatElement(t,e,i)},t.FormMessenger=m}(fm||(fm={}));var FormMessenger=fm.FormMessenger;window.addEventListener("load",function(){var t=document.querySelector("#fm-initiator"),e=document.querySelector("#fm-container");t&&(window.FormMessenger=new FormMessenger({formEl:t,containerEl:e}))});