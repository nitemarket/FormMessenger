var fm;!function(t){"use strict";var e={chatListClass:"",chatElementClass:"",bubbleListClass:"",bubbleElementClass:"",inputContainerClass:"",inputBoxClass:"",inputButtonClass:"",previousResponsePattern:"{{previousResponse}}",formCompleteCallback:null,formSubmissionText:null,formValidation:{email:function(t){/^\w+([\.\-]?\ w+)*@\w+([\.\-]?\ w+)*(\.\w{2,3})+$/.test(t)||this.setErrorAndReply("Please provide a valid email.")},password:function(t){/(?=.*\d)(?=.*[a-z]).{6,}/.test(t)||this.setErrorAndReply("Password must contain one number, one lowercase and at least 6 in length.")},interest:function(t){t instanceof Array&&t.length<1&&this.setErrorAndReply("Please select at least one.")}}},i={userInputSubmit:"fm-user-input-submit",userInputUpdate:"fm-user-input-update",userInputKeyChange:"fm-user-input-key-change",onBubbleClick:"fm-on-bubble-click",onUserInputError:"fm-user-input-error",flowUpdate:"fm-flow-update"},s={tagNameRequest:"Please provide us your {tagName}",formSelectionQuestion:"Which do you want to proceed?",formYesNoQuestion:"Would you like to proceed to {label}",notAvailableResponse:"Not available"},n=function(t){this.fmReference=t,this.inputCache={}};n.prototype.store=function(t,e){this.inputCache.hasOwnProperty(t)||(this.inputCache[t]=[]),this.inputCache[t].indexOf(e)<=-1&&this.inputCache[t].push(e)},n.prototype.retrieve=function(t){return this.inputCache.hasOwnProperty(t)?this.inputCache[t]:[]};var o=function(t){};o.isTagValid=function(t){return!t.hasAttribute("fm-disabled")&&(!(["hidden","submit","button"].indexOf(t.getAttribute("type"))>=0)&&(!(["true","disabled"].indexOf(t.getAttribute("disabled"))>=0)&&"button"!=t.tagName))},o.isTagGroup=function(t){return["radio","checkbox"].indexOf(t.getAttribute("type"))>=0};var r=function(t){o.call(this),this.element=t};r.prototype=Object.create(o.prototype),r.prototype.constructor=r,r.prototype.getAttrName=function(){return this.element.getAttribute("name")},r.prototype.setInputValue=function(t){this.element.value=t},r.prototype.isInputSensitive=function(){return!("password"!=this.element.getAttribute("type")&&!this.element.hasAttribute("fm-sensitive"))},r.prototype.getPlaceHolder=function(){return this.element.getAttribute("placeholder")},r.prototype.getBubbles=function(t){var e=[];if(!this.element.hasAttribute("fm-nobubble")&&!this.isInputSensitive()){var i=t.retrieve(this.getAttrName());this.element.value&&i.indexOf(this.element.value)<=-1&&i.push(this.element.value),i&&i.forEach(function(t){e.push({value:t,label:t})})}return e},r.prototype.getQuestion=function(){return(!this.questions||this.questions.length<=0)&&(this.questions=[],this.element&&this.element.getAttribute("fm-questions")&&(this.questions=this.element.getAttribute("fm-questions").split("|")),this.questions.length<=0&&this.questions.push(s.tagNameRequest.replace("{tagName}",this.element.getAttribute("name")))),this.questions[Math.floor(Math.random()*this.questions.length)].trim()};var l=function(t,e){o.call(this),this.attrName=t,this.type=e,this.elements=[]};l.prototype=Object.create(o.prototype),l.prototype.constructor=l,l.prototype.getAttrName=function(){return this.attrName},l.prototype.addElement=function(t){this.elements.push(t)},l.prototype.setInputValue=function(t,e){this.elements.forEach(function(i){i.getAttribute("value")==t&&(i.checked=e)})},l.prototype.getQuestion=function(){var t=this;return(!this.questions||this.questions.length<=0)&&(this.questions=[],this.elements.some(function(e){var i=e.getAttribute("fm-questions");if(i)return t.questions=i.split("|"),!0}),this.questions.length<=0&&this.questions.push(s.tagNameRequest.replace("{tagName}",this.attrName))),this.questions[Math.floor(Math.random()*this.questions.length)].trim()},l.prototype.getBubbles=function(t){var e=[];return this.elements.forEach(function(t){e.push({value:t.value,label:t.getAttribute("fm-label")||t.value,isChecked:t.checked})}),e},l.prototype.getCheckedValuesForMsg=function(){var t=[];return this.elements.forEach(function(e){if(e.checked){var i=e.getAttribute("fm-label")||e.value;t.push(i)}}),t};var u=function(t){return this.step=0,this.maxSteps=t.tags.length,this.tags=t.tags,this.fmReference=t.fmReference,this.repeatStep=!1,this.userInputSubmitCallback=this.userInputSubmit.bind(this),document.addEventListener(i.userInputSubmit,this.userInputSubmitCallback,!1),this.onBubbleClickCallback=this.onBubbleClick.bind(this),document.addEventListener(i.onBubbleClick,this.onBubbleClickCallback,!1),this};Object.defineProperty(u.prototype,"currentTag",{get:function(){return this.tags[this.step]},enumerable:!0,configurable:!0}),u.prototype.start=function(){return this.processStep(),this},u.prototype.nextStep=function(){this.step++,this.processStep()},u.prototype.processStep=function(){this.step==this.maxSteps?this.fmReference.doSubmitForm():(this.step%=this.maxSteps,this.showStep())},u.prototype.showStep=function(){var t=this;document.dispatchEvent(new CustomEvent(i.flowUpdate,{detail:t.currentTag}))},u.prototype.userInputSubmit=function(t){var e,s,n=this;if(this.repeatStep=!1,this.fmReference.isProcessing())return!1;if(this.fmReference.setProcessing(!0),this.currentTag instanceof r)if(e=t.detail.value,s=e.trim(),this.currentTag.setInputValue(s),this.currentTag.isInputSensitive()){for(var o="",u=0;u<s.length;u++)o+="*";s=o}else this.fmReference.globalBubble.store(this.currentTag.getAttrName(),s);else this.currentTag instanceof l&&(e=this.currentTag.getCheckedValuesForMsg(),s=e.join(", "));document.dispatchEvent(new CustomEvent(i.userInputUpdate,{detail:s})),this.validateInput(e)&&!this.repeatStep&&setTimeout(function(){return n.nextStep()},250)},u.prototype.onBubbleClick=function(t){var e=t.detail.value;this.currentTag instanceof r?this.userInputSubmit(t):this.currentTag instanceof l&&("radio"==this.currentTag.type?(this.currentTag.setInputValue(e,!0),this.userInputSubmit(t)):this.currentTag.setInputValue(e,t.detail.isChecked))},u.prototype.validateInput=function(t){var e=this.currentTag.getAttrName();return this.fmReference.options.formValidation.hasOwnProperty(e)&&this.fmReference.options.formValidation[e].call(this,t),!0},u.prototype.setErrorAndReply=function(t){this.repeatStep=!0,document.dispatchEvent(new CustomEvent(i.onUserInputError,{detail:t}))},u.prototype.removeEventListener=function(){document.removeEventListener(i.userInputSubmit,this.userInputSubmitCallback,!1),this.userInputSubmitCallback=null,document.removeEventListener(i.onBubbleClick,this.onBubbleClickCallback,!1),this.onBubbleClickCallback=null};var a=function(t){return this.fmReference=t,this.el=document.createElement("div"),this.el.id="fmChatList",this.el.className=this.fmReference.options.chatListClass.trim(),this.onUserInputUpdateCallback=this.onUserInputUpdate.bind(this),document.addEventListener(i.userInputUpdate,this.onUserInputUpdateCallback,!1),this};a.prototype.onUserInputUpdate=function(t){this.buildUserChatElement(t.detail),this.fmReference.setCurrentResponse(t.detail)},a.prototype.buildUserChatElement=function(t){var e=t||s.notAvailableResponse,i=document.createElement("div");i.className=("fm-chat-element fm-user fm-clearfix "+this.fmReference.options.chatElementClass).trim(),i.textContent=e,t||(i.className+=" skip"),this.el.appendChild(i),this.scrollToBottom()},a.prototype.buildBotChatElement=function(t,e){if(t){var i=document.createElement("div");i.className=("fm-chat-element fm-bot fm-clearfix "+this.fmReference.options.chatElementClass).trim(),i.textContent=t,"error"==e?i.className+=" error":"info"==e&&(i.className+=" info"),this.el.appendChild(i),this.scrollToBottom()}},a.prototype.scrollToBottom=function(){this.el.scrollTop=this.el.scrollHeight-this.el.clientHeight};var h=function(t){return this.fmReference=t,this.bubbles=[],this.toggleable=!1,this.el=document.createElement("div"),this.el.id="fmBubbleList",this.el.className=this.fmReference.options.bubbleListClass.trim(),this.userInputKeyChangeCallback=this.userInputKeyChange.bind(this),document.addEventListener(i.userInputKeyChange,this.userInputKeyChangeCallback,!1),this};h.prototype.userInputKeyChange=function(t){if(this.bubbles.length>0){var e=[];t.detail?this.bubbles.forEach(function(i){t.detail&&i.label.toLowerCase().indexOf(t.detail.toLowerCase())!==-1&&e.push(i)}):e=this.bubbles,this.renderBubbles(e)}},h.prototype.prePopulateInputBubble=function(t,e){this.reset(),this.bubbles=t.getBubbles(e),"checkbox"==t.type&&(this.toggleable=!0),this.renderBubbles()},h.prototype.prePopulateLinkBubble=function(t){this.reset(),this.bubbles=t,this.renderBubbles()},h.prototype.clearBubbles=function(){this.reset(),this.bubbles=[],this.renderBubbles()},h.prototype.renderBubbles=function(t){for(var e=this,t=t||this.bubbles;this.el.hasChildNodes();)this.el.removeChild(this.el.lastChild);t.length>0&&t.forEach(function(t){var i=document.createElement("div");i.className=("fm-bubble-element "+e.fmReference.options.bubbleElementClass).trim(),i.textContent=t.label,t.isChecked&&(i.className+=" selected"),e.toggleable&&(i.className+=" checkbox"),e.el.appendChild(i),t.isFormSelection||t.isFormYes?i.addEventListener("click",function(){e.handleFormSelectionClick.call(e,t)},!1):t.isFormNo?t.hasOwnProperty("callback")&&"function"==typeof t.callback&&i.addEventListener("click",function(){e.handleFormNo.call(e,t)},!1):i.addEventListener("click",function(){e.handleBubbleClick.call(this,t.value,e)},!1)})},h.prototype.handleBubbleClick=function(t,e){e.toggleable?this.classList.toggle("selected"):([].forEach.call(e.el.childNodes,function(t){t.classList.remove("selected")}),this.classList.add("selected")),document.dispatchEvent(new CustomEvent(i.onBubbleClick,{detail:{value:t,isChecked:this.classList.contains("selected")}}))},h.prototype.onBubbleLinkClick=function(t){return!this.fmReference.isProcessing()&&(this.fmReference.setProcessing(!0),void document.dispatchEvent(new CustomEvent(i.userInputUpdate,{detail:t.label})))},h.prototype.handleFormSelectionClick=function(t){var e=this;this.onBubbleLinkClick(t),setTimeout(function(){e.fmReference.initForm(t.value)},250)},h.prototype.handleFormNo=function(t){var e=this;this.onBubbleLinkClick(t),setTimeout(function(){t.callback.call(e.fmReference),e.fmReference.setProcessing(!1)},250)},h.prototype.reset=function(){this.toggleable=!1};var p=function(t){return this.fmReference=t,this.disabled=!1,this.referCurrentResponse=!0,this.el=document.createElement("div"),this.el.id="fmInputContainer",this.el.className=this.fmReference.options.inputContainerClass.trim(),this.inputEl=document.createElement("input"),this.inputEl.type="text",this.inputEl.id="fmInputBox",this.inputEl.className=this.fmReference.options.inputBoxClass.trim(),this.inputBtnEl=document.createElement("button"),this.inputBtnEl.type="button",this.inputBtnEl.id="fmInputBtn",this.inputBtnEl.innerHTML="Send",this.inputBtnEl.className=this.fmReference.options.inputButtonClass.trim(),this.el.appendChild(this.inputEl),this.el.appendChild(this.inputBtnEl),this.onKeyUpCallback=this.onKeyUp.bind(this),this.inputEl.addEventListener("keyup",this.onKeyUpCallback,!1),this.onEnterOrSubmitBtnCallback=this.onEnterOrSubmitBtn.bind(this),this.inputBtnEl.addEventListener("click",this.onEnterOrSubmitBtnCallback,!1),this};p.prototype.onKeyUp=function(t){var e=this;return!this.disabled&&void(13==t.keyCode?this.onEnterOrSubmitBtn():38==t.keyCode&&this.referCurrentResponse?this.inputEl.value=this.fmReference.currentResponse:document.dispatchEvent(new CustomEvent(i.userInputKeyChange,{detail:e.inputEl.value})))},p.prototype.onEnterOrSubmitBtn=function(){return!this.disabled&&void document.dispatchEvent(new CustomEvent(i.userInputSubmit,{detail:{value:this.inputEl.value}}))},p.prototype.hideUserInput=function(t){t?(this.referCurrentResponse=!1,this.inputEl.setAttribute("type","password")):this.inputEl.setAttribute("type","text")},p.prototype.setPlaceHolder=function(t){this.inputEl.setAttribute("placeholder",t)},p.prototype.focusInputBox=function(){this.inputEl.focus()},p.prototype.clearInput=function(){this.inputEl.value=""},p.prototype.setDisabled=function(t){this.disabled=!!t,t?(this.inputEl.setAttribute("disabled","disabled"),this.inputBtnEl.setAttribute("disabled","disabled")):(this.inputEl.removeAttribute("disabled"),this.inputBtnEl.removeAttribute("disabled"))},p.prototype.reset=function(){this.referCurrentResponse=!0,this.inputBtnEl.innerHTML="Send",this.setDisabled(!1),this.clearInput()},p.prototype.setInputBtnLabel=function(t){this.inputBtnEl.innerHTML=t};var c=function(t){if(!t.formEl&&!t.formSelection)throw new Error("Conversational Form error, Invalid formEl.");var s=this;this.options=Object.assign({},e,t),this.formEl=t.formEl,this.containerEl=t.containerEl?t.containerEl:document.body,this.tags=[],this.currentResponse="",this.processing=!1,this.globalBubble=new n(this),this.buildUI(),this.onFlowUpdateCallback=this.onFlowUpdate.bind(this),document.addEventListener(i.flowUpdate,this.onFlowUpdateCallback,!1),this.onUserInputErrorCallback=this.onUserInputError.bind(this),document.addEventListener(i.onUserInputError,this.onUserInputErrorCallback,!1),this.formEl?(this.formEl.setAttribute("novalidate",""),setTimeout(function(){return s.initForm(s.formEl)},0)):t.formSelection&&this.setFormSelection(t.formSelection,t.formSelectionQuestion)};c.prototype.isProcessing=function(){return this.processing===!0},c.prototype.setProcessing=function(t){this.processing=t},c.prototype.reset=function(){this.tags=[],this.currentResponse="",this.processing=!1},c.prototype.initForm=function(t){this.formEl=t,this.reset();for(var e=[].slice.call(this.formEl.querySelectorAll("input, button"),0),i={},s=0;s<e.length;s++){var n=e[s];if(o.isTagValid(n))if(o.isTagGroup(n)){var a=n.getAttribute("name"),h=n.getAttribute("type");if(!i.hasOwnProperty(a)){var p=new l(a,h);this.tags.push(p),i[a]=p}i[a].addElement(n)}else this.tags.push(new r(n))}this.flowManager&&this.flowManager.removeEventListener(),this.flowManager=new u({fmReference:this,tags:this.tags}).start()},c.prototype.buildUI=function(){this.el=document.createElement("div"),this.el.id="form-messenger",this.containerEl.appendChild(this.el),this.chatEl=new a(this),this.el.appendChild(this.chatEl.el),this.bubbleEl=new h(this),this.el.appendChild(this.bubbleEl.el),this.userInput=new p(this),this.el.appendChild(this.userInput.el)},c.prototype.onFlowUpdate=function(t){var e=t.detail,i=e.getQuestion().split(this.options.previousResponsePattern).join(this.currentResponse);this.chatEl.buildBotChatElement(i),this.userInput.reset(),e instanceof r?(this.userInput.hideUserInput(e.isInputSensitive()),this.userInput.setPlaceHolder(e.getPlaceHolder()),this.userInput.focusInputBox()):e instanceof l&&this.userInput.setPlaceHolder("Search"),this.bubbleEl.prePopulateInputBubble(e,this.globalBubble),this.setProcessing(!1)},c.prototype.doSubmitForm=function(){if(this.formCompleteCallback&&"function"==typeof this.formCompleteCallback)this.formCompleteCallback.call(this);else{this.options.formSubmissionText&&this.chatEl.buildBotChatElement(this.options.formSubmissionText),this.userInput.setDisabled(!0);var t=[].slice.call(this.formEl.querySelectorAll("input, button"),0);if(t.length>0)for(var e=0;e<t.length;e++)"submit"==t[e].getAttribute("type")&&t[e].click();else this.formEl.submit()}this.setProcessing(!1)},c.prototype.setCurrentResponse=function(t){this.userInput.clearInput(),this.currentResponse=t},c.prototype.onUserInputError=function(t){this.chatEl.buildBotChatElement(t.detail,"error"),this.setProcessing(!1)},c.prototype.setFormSelection=function(t,e){this.userInput.reset();var e=e||s.formSelectionQuestion;this.chatEl.buildBotChatElement(e);var i=[];for(var n in t)i.push({label:n,value:t[n],isFormSelection:!0});this.bubbleEl.prePopulateLinkBubble(i)},c.prototype.setFormYesNo=function(t,e,i){this.userInput.reset();var e=e||s.formYesNoQuestion.repeat("{label}",t.label);this.chatEl.buildBotChatElement(e);var n=[];n.push({label:"Yes",value:t.elem,isFormYes:!0}),n.push({label:"No",value:null,callback:i,isFormNo:!0}),this.bubbleEl.prePopulateLinkBubble(n)},c.prototype.setErrorResponse=function(t){this.chatEl.buildBotChatElement(t,"error")},c.prototype.setInfoResponse=function(t){this.chatEl.buildBotChatElement(t,"info")},t.FormMessenger=c}(fm||(fm={}));var FormMessenger=fm.FormMessenger;window.addEventListener("load",function(){var t=document.querySelector("#fm-initiator"),e=document.querySelector("#fm-container");t&&(window.FormMessenger=new FormMessenger({formEl:t,containerEl:e}))});