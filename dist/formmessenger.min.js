var fm;!function(t){"use strict";var e={chatListClass:"",chatElementClass:"",bubbleListClass:"",bubbleElementClass:"",inputContainerClass:"",inputBoxClass:"",inputButtonClass:"",previousResponsePattern:"{{previousResponse}}",formCompleteCallback:null},i={userInputSubmit:"fm-user-input-submit",userInputUpdate:"fm-user-input-update",userInputKeyChange:"fm-user-input-key-change",onBubbleClick:"fm-on-bubble-click",flowUpdate:"fm-flow-update"},s=function(t){};s.isTagValid=function(t){return!t.hasAttribute("fm-disabled")&&(!(["hidden","submit","button"].indexOf(t.getAttribute("type"))>=0)&&(!(["true","disabled"].indexOf(t.getAttribute("disabled"))>=0)&&"button"!=t.tagName))},s.isTagGroup=function(t){return["radio","checkbox"].indexOf(t.getAttribute("type"))>=0};var n=function(t){s.call(this),this.element=t};n.prototype=Object.create(s.prototype),n.prototype.constructor=n,n.prototype.setInputValue=function(t){this.element.value=t},n.prototype.isInputSensitive=function(){return"password"==this.element.getAttribute("type")},n.prototype.getPlaceHolder=function(){return this.element.getAttribute("placeholder")},n.prototype.getBubbles=function(){var t=[];return this.element.value&&t.push({value:this.element.value,label:this.element.value}),t},n.prototype.getQuestion=function(){return(!this.questions||this.questions.length<=0)&&(this.questions=[],this.element&&this.element.getAttribute("fm-questions")&&(this.questions=this.element.getAttribute("fm-questions").split("|")),this.questions.length<=0&&this.questions.push("Please provide us your "+this.element.getAttribute("name"))),this.questions[Math.floor(Math.random()*this.questions.length)].trim()};var l=function(t,e){s.call(this),this.attrName=t,this.type=e,this.elements=[]};l.prototype=Object.create(s.prototype),l.prototype.constructor=l,l.prototype.addElement=function(t){this.elements.push(t)},l.prototype.setInputValue=function(t,e){this.elements.forEach(function(i){i.getAttribute("value")==t&&(i.checked=e)})},l.prototype.getQuestion=function(){var t=this;return(!this.questions||this.questions.length<=0)&&(this.questions=[],this.elements.some(function(e){var i=e.getAttribute("fm-questions");if(i)return t.questions=i.split("|"),!0}),this.questions.length<=0&&this.questions.push("Please provide us your "+this.attrName)),this.questions[Math.floor(Math.random()*this.questions.length)].trim()},l.prototype.getBubbles=function(){var t=[];return this.elements.forEach(function(e){t.push({value:e.value,label:e.getAttribute("fm-label")||e.value})}),t},l.prototype.getCheckedValuesForMsg=function(){var t=[];return this.elements.forEach(function(e){if(e.checked){var i=e.getAttribute("fm-label")||e.value;t.push(i)}}),t};var o=function(t){return this.step=0,this.maxSteps=t.tags.length,this.tags=t.tags,this.fmReference=t.fmReference,this.userInputSubmitCallback=this.userInputSubmit.bind(this),document.addEventListener(i.userInputSubmit,this.userInputSubmitCallback,!1),this.onBubbleClickCallback=this.onBubbleClick.bind(this),document.addEventListener(i.onBubbleClick,this.onBubbleClickCallback,!1),this};Object.defineProperty(o.prototype,"currentTag",{get:function(){return this.tags[this.step]},enumerable:!0,configurable:!0}),o.prototype.start=function(){this.processStep()},o.prototype.nextStep=function(){this.step++,this.processStep()},o.prototype.processStep=function(){this.step==this.maxSteps?this.fmReference.doSubmitForm():(this.step%=this.maxSteps,this.showStep())},o.prototype.showStep=function(){var t=this;document.dispatchEvent(new CustomEvent(i.flowUpdate,{detail:t.currentTag}))},o.prototype.userInputSubmit=function(t){var e=this;if(this.fmReference.isProcessing())return!1;if(this.fmReference.processing=!0,this.currentTag instanceof n){var s=t.detail.value.trim();if(this.currentTag.setInputValue(s),this.currentTag.isInputSensitive()){for(var o="",u=0;u<s.length;u++)o+="*";s=o}}else this.currentTag instanceof l&&(s=this.currentTag.getCheckedValuesForMsg().join(", "));document.dispatchEvent(new CustomEvent(i.userInputUpdate,{detail:s})),setTimeout(function(){return e.nextStep()},250)},o.prototype.onBubbleClick=function(t){var e=t.detail.value,i=t.detail.isChecked;this.currentTag instanceof n?this.userInputSubmit(t):this.currentTag instanceof l&&(this.currentTag.setInputValue(e,i),"radio"==this.currentTag.type&&this.userInputSubmit(t))};var u=function(t){return this.fmReference=t,this.el=document.createElement("div"),this.el.id="fmChatList",this.el.className=e.chatListClass.trim(),this.onUserInputUpdateCallback=this.onUserInputUpdate.bind(this),document.addEventListener(i.userInputUpdate,this.onUserInputUpdateCallback,!1),this};u.prototype.onUserInputUpdate=function(t){this.buildUserChatElement(t.detail),this.fmReference.setCurrentResponse(t.detail)},u.prototype.buildUserChatElement=function(t){var i=document.createElement("div");i.className=("fm-chat-element fm-user fm-clearfix "+e.chatElementClass).trim(),i.textContent=t,this.el.appendChild(i),this.scrollToBottom()},u.prototype.buildBotChatElement=function(t){var i=document.createElement("div");i.className=("fm-chat-element fm-bot fm-clearfix "+e.chatElementClass).trim(),i.textContent=t,this.el.appendChild(i),this.scrollToBottom()},u.prototype.scrollToBottom=function(){this.el.scrollTop=this.el.scrollHeight-this.el.clientHeight};var r=function(t){return this.fmReference=t,this.bubbles=[],this.filterableBubbles=!0,this.el=document.createElement("div"),this.el.id="fmBubbleList",this.el.className=e.bubbleListClass.trim(),this.userInputKeyChangeCallback=this.userInputKeyChange.bind(this),document.addEventListener(i.userInputKeyChange,this.userInputKeyChangeCallback,!1),this};r.prototype.userInputKeyChange=function(t){if(this.bubbles.length>0&&this.filterableBubbles){var e=[];t.detail?this.bubbles.forEach(function(i){t.detail&&i.label.toLowerCase().indexOf(t.detail.toLowerCase())!==-1&&e.push(i)}):e=this.bubbles,this.renderBubbles(e)}},r.prototype.prePopulateBubble=function(t){this.bubbles=t.getBubbles(),this.filterableBubbles=!(t instanceof n),this.renderBubbles()},r.prototype.clearBubbles=function(){this.bubbles=[],this.renderBubbles()},r.prototype.renderBubbles=function(t){for(var i=this,t=t||this.bubbles;this.el.hasChildNodes();)this.el.removeChild(this.el.lastChild);t.length>0&&t.forEach(function(t){var s=document.createElement("div");s.className=("fm-bubble-element "+e.bubbleElementClass).trim(),s.textContent=t.label,i.el.appendChild(s),s.addEventListener("click",function(){i.handleBubbleClick.call(this,t.value)},!1)})},r.prototype.handleBubbleClick=function(t){this.classList.toggle("selected"),document.dispatchEvent(new CustomEvent(i.onBubbleClick,{detail:{value:t,isChecked:this.classList.contains("selected")}}))};var a=function(t){return this.fmReference=t,this.disabled=!1,this.el=document.createElement("div"),this.el.id="fmInputContainer",this.el.className=e.inputContainerClass.trim(),this.inputEl=document.createElement("input"),this.inputEl.type="text",this.inputEl.id="fmInputBox",this.inputEl.className=e.inputBoxClass.trim(),this.inputBtnEl=document.createElement("button"),this.inputBtnEl.type="button",this.inputBtnEl.id="fmInputBtn",this.inputBtnEl.innerHTML="Send",this.inputBtnEl.className=e.inputButtonClass.trim(),this.el.appendChild(this.inputEl),this.el.appendChild(this.inputBtnEl),this.onKeyUpCallback=this.onKeyUp.bind(this),this.inputEl.addEventListener("keyup",this.onKeyUpCallback,!1),this.onEnterOrSubmitBtnCallback=this.onEnterOrSubmitBtn.bind(this),this.inputBtnEl.addEventListener("click",this.onEnterOrSubmitBtnCallback,!1),this};a.prototype.onKeyUp=function(t){var e=this;return!this.disabled&&void(13==t.keyCode?this.onEnterOrSubmitBtn():document.dispatchEvent(new CustomEvent(i.userInputKeyChange,{detail:e.inputEl.value})))},a.prototype.onEnterOrSubmitBtn=function(){return!this.disabled&&void document.dispatchEvent(new CustomEvent(i.userInputSubmit,{detail:{value:this.inputEl.value}}))},a.prototype.hideUserInput=function(t){t?this.inputEl.setAttribute("type","password"):this.inputEl.setAttribute("type","text")},a.prototype.setPlaceHolder=function(t){this.inputEl.setAttribute("placeholder",t)},a.prototype.focusInputBox=function(){this.inputEl.focus()},a.prototype.clearInput=function(){this.inputEl.value=""},a.prototype.setDisabled=function(t){this.disabled=!!t,t?(this.inputEl.setAttribute("disabled","disabled"),this.inputBtnEl.setAttribute("disabled","disabled")):(this.inputEl.removeAttribute("disabled"),this.inputBtnEl.removeAttribute("disabled"))};var h=function(t){if(!t.formEl)throw new Error("Conversational Form error, Invalid formEl.");var s=this;this.options=Object.assign({},e,t),this.formEl=t.formEl,this.containerEl=t.containerEl?t.containerEl:document.body,this.tags=[],this.currentResponse="",this.processing=!1,this.buildUI(),this.onFlowUpdateCallback=this.onFlowUpdate.bind(this),document.addEventListener(i.flowUpdate,this.onFlowUpdateCallback,!1),setTimeout(function(){return s.initForm(t.formEl)},0)};h.prototype.isProcessing=function(){return this.processing===!0},h.prototype.initForm=function(t){this.formEl=t;for(var e=[].slice.call(this.formEl.querySelectorAll("input, button"),0),i={},u=0;u<e.length;u++){var r=e[u];if(s.isTagValid(r))if(s.isTagGroup(r)){var a=r.getAttribute("name"),h=r.getAttribute("type");if(!i.hasOwnProperty(a)){var p=new l(a,h);this.tags.push(p),i[a]=p}i[a].addElement(r)}else this.tags.push(new n(r))}this.flowManager=new o({fmReference:this,tags:this.tags}).start()},h.prototype.buildUI=function(){this.el=document.createElement("div"),this.el.id="form-messenger",this.containerEl.appendChild(this.el),this.chatEl=new u(this),this.el.appendChild(this.chatEl.el),this.bubbleEl=new r(this),this.el.appendChild(this.bubbleEl.el),this.userInput=new a(this),this.el.appendChild(this.userInput.el)},h.prototype.onFlowUpdate=function(t){var i=t.detail,s=i.getQuestion().split(e.previousResponsePattern).join(this.currentResponse);this.chatEl.buildBotChatElement(s),i instanceof n&&(this.userInput.hideUserInput(i.isInputSensitive()),this.userInput.setPlaceHolder(i.getPlaceHolder()),this.userInput.focusInputBox()),this.bubbleEl.prePopulateBubble(i),i instanceof l&&this.userInput.setPlaceHolder("Search"),this.processing=!1},h.prototype.doSubmitForm=function(){if(this.formCompleteCallback&&"function"==typeof this.formCompleteCallback)this.formCompleteCallback();else{this.chatEl.buildBotChatElement("Sending form..."),this.userInput.setDisabled(!0);var t=[].slice.call(this.formEl.querySelectorAll("input, button"),0);if(t.length>0)for(var e=0;e<t.length;e++)"submit"==t[e].getAttribute("type")&&t[e].click();else this.formEl.submit()}},h.prototype.setCurrentResponse=function(t){this.userInput.clearInput(),this.currentResponse=t},t.FormMessenger=h}(fm||(fm={}));var FormMessenger=fm.FormMessenger;window.addEventListener("load",function(){var t=document.querySelector("#fm-initiator"),e=document.querySelector("#fm-container");t&&(window.FormMessenger=new FormMessenger({formEl:t,containerEl:e}))});